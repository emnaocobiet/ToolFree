<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LC79 Minimal Local</title>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
        #bg-iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; }

        #floating-box {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 140px;
            height: 90px;
            background: #fff;
            color: #000;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: move;
            user-select: none;
            z-index: 9999;
            box-shadow: 0 5px 15px rgba(0,0,0,0.4);
            font-family: Arial, sans-serif;
            font-weight: bold;
        }

        .phien-hien-tai { font-size: 16px; margin-bottom: 5px; color: #333; }
        .du-doan { font-size: 26px; text-transform: uppercase; color: #000; }
        
        .status { font-size: 24px; }
        .win { color: #27ae60; }
        .lose { color: #c0392b; }
    </style>
</head>
<body>

    <iframe id="bg-iframe" src="https://play.lc79.bet/"></iframe>

    <div id="floating-box">
        <div id="content">Đang tải...</div>
    </div>

    <script>
        const box = document.getElementById('floating-box');
        const content = document.getElementById('content');
        
        let lastPred = null;
        let isShowingResult = false;

        // Kéo thả (Mobile & PC)
        let isDrag = false, ox, oy;
        const start = (e) => { isDrag = true; ox = (e.clientX || e.touches[0].clientX) - box.offsetLeft; oy = (e.clientY || e.touches[0].clientY) - box.offsetTop; };
        const move = (e) => { if(!isDrag) return; box.style.left = ((e.clientX || e.touches[0].clientX) - ox) + 'px'; box.style.top = ((e.clientY || e.touches[0].clientY) - oy) + 'px'; };
        const end = () => isDrag = false;

        box.addEventListener('mousedown', start); box.addEventListener('touchstart', start);
        document.addEventListener('mousemove', move); document.addEventListener('touchmove', move);
        document.addEventListener('mouseup', end); document.addEventListener('touchend', end);

        async function update() {
            if (isShowingResult) return;
            try {
                // Gọi trực tiếp đến file api.php cùng thư mục
                // Thêm tham số t để tránh cache trình duyệt
                const res = await fetch('api.php?t=' + new Date().getTime());
                const data = await res.json();

                if(data.error) {
                    console.error(data.error);
                    return;
                }

                // Logic so sánh kết quả phiên trước
                if (lastPred && data.phien === lastPred.phien_hien_tai) {
                    isShowingResult = true;
                    // Kiểm tra thắng thua dựa trên dữ liệu trả về
                    const win = data.ket_qua === lastPred.du_doan;
                    
                    content.innerHTML = `<div class="status ${win?'win':'lose'}">${win?'THẮNG':'THUA'}</div>`;
                    
                    // Reset dự đoán cũ để chuẩn bị cho phiên mới
                    lastPred = null;
                    
                    // Hiện kết quả 3 giây rồi quay lại trạng thái bình thường
                    setTimeout(() => { 
                        isShowingResult = false; 
                        // Gọi update ngay lập tức để lấy phiên mới nhất
                        update(); 
                    }, 3000); 
                    return;
                }

                // Hiển thị nội dung dự đoán phiên mới
                content.innerHTML = `
                    <div class="phien-hien-tai">${data.phien_hien_tai}</div>
                    <div class="du-doan">${data.du_doan}</div>
                `;
                
                // Lưu lại phiên hiện tại để so sánh lần sau
                lastPred = { phien_hien_tai: data.phien_hien_tai, du_doan: data.du_doan };

            } catch (e) {
                console.log("Lỗi kết nối:", e);
                content.innerHTML = '<div style="font-size:12px">Lỗi mạng</div>';
            }
        }

        // Cập nhật mỗi 3 giây
        setInterval(update, 3000);
        update();
    </script>
</body>
</html>
